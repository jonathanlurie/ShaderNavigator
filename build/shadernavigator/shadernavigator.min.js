var $jscomp={scope:{},inherits:function(d,h){function m(){}m.prototype=h.prototype;d.prototype=new m;d.prototype.constructor=d;for(var f in h)if(Object.defineProperties){var l=Object.getOwnPropertyDescriptor(h,f);l&&Object.defineProperty(d,f,l)}else d[f]=h[f]}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,h,m){if(m.get||m.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[h]=m.value)};
$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(d,h,m,f){if(h){m=$jscomp.global;d=d.split(".");for(f=0;f<d.length-1;f++){var l=d[f];l in m||(m[l]={});m=m[l]}d=d[d.length-1];f=m[d];h=h(f);h!=f&&null!=h&&$jscomp.defineProperty(m,d,{configurable:!0,writable:!0,value:h})}};
$jscomp.polyfill("Math.sign",function(d){return d?d:function(d){d=Number(d);return 0===d||isNaN(d)?d:0<d?1:-1}},"es6-impl","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var h=0;return $jscomp.iteratorPrototype(function(){return h<d.length?{done:!1,value:d[h++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(d,h){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var m=0,f={next:function(){if(m<d.length){var l=m++;return{value:h(l,d[l]),done:!1}}f.next=function(){return{done:!0,value:void 0}};return f.next()}};f[Symbol.iterator]=function(){return f};return f};
$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6-impl","es3");
(function(d,h){"object"===typeof exports&&"undefined"!==typeof module?h(exports):"function"===typeof define&&define.amd?define(["exports"],h):h(d.SHAD=d.SHAD||{})})(this,function(d){var h=function(a){this._textureChunk=a},m=function(a){this._textureChunk=a;return this};$jscomp.inherits(m,h);m.prototype._buildFileName=function(){var a=this._textureChunk.getIndex3D(),b=this._textureChunk.getVoxelPerSide(),c=this._textureChunk.getWorkingDir(),e=this._textureChunk.getResolutionLevel(),u=a[0]*b,d=a[1]*
b,a=a[2]*b;return c+"/"+e+"/"+u+"-"+(u+b)+"/"+d+"-"+(d+b)+"/"+a+"-"+(a+b)};m.prototype.loadTexture=function(){var a=this._buildFileName(),b=this,c=(new THREE.TextureLoader).load(a,function(){c.magFilter=THREE.NearestFilter;c.minFilter=THREE.NearestFilter;b._textureChunk.setTexture(c);b._textureChunk.onTextureSuccessToLoad()},function(){},function(){b._textureChunk.onTextureFailedToLoad()})};var f=function(a,b,c,e,u,d,g){this._chunkID=u;this._matrix3DSize=g;this._voxelPerSide=b;this._workingDir=e;
this._resolutionLevel=a;this._sizeWC=c;this._threeJsTexture=null;this._triedToLoad=this._textureLoadingError=this._isBuilt=!1;this._textureLoader=this._onTextureLoadErrorCallback=this._onTextureLoadedCallback=null;"precomputed_octree_tiles"==d&&(this._textureLoader=new m(this))};f.prototype.getVoxelPerSide=function(){return this._voxelPerSide};f.prototype.getIndex3D=function(){return this._index3D.slice()};f.prototype.getWorkingDir=function(){return this._workingDir};f.prototype.getResolutionLevel=
function(){return this._resolutionLevel};f.prototype.setTexture=function(a){this._threeJsTexture=a};f.prototype.buildFromIndex3D=function(a){this._index3D=a.slice();this._findChunkOrigin();this._triedToLoad||this._textureLoader.loadTexture();this._isBuilt=!0};f.prototype._findChunkOrigin=function(){this._originWC=new THREE.Vector3(this._index3D[0]*this._sizeWC,this._index3D[1]*this._sizeWC,this._index3D[2]*this._sizeWC)};f.prototype.onTextureSuccessToLoad=function(){this._textureLoadingError=!1;this._triedToLoad=
!0;this._onTextureLoadedCallback&&this._onTextureLoadedCallback(this._chunkID)};f.prototype.onTextureFailedToLoad=function(){this._threeJsTexture=null;this._triedToLoad=this._textureLoadingError=!0;this._onTextureLoadErrorCallback&&this._onTextureLoadErrorCallback(this._chunkID)};f.prototype._loadTextureDecode=function(){var a=this,b=new XMLHttpRequest;b.open("GET",this._filepath);b.responseType="arraybuffer";b.onload=function(){var c=new Uint8Array(b.response),e,u;u=new JpegDecoder;u.parse(c);c=
u.width;e=u.height;u=u.getData(c,e);a._threeJsTexture=new THREE.DataTexture(u,c,e,THREE.LuminanceFormat);a._threeJsTexture.magFilter=THREE.NearestFilter;a._threeJsTexture.minFilter=THREE.NearestFilter;a._threeJsTexture.flipY=!0;a._threeJsTexture.needsUpdate=!0;a._textureLoadingError=!1;a._triedToLoad=!0;a._onTextureLoadedCallback&&a._onTextureLoadedCallback(a._chunkID)};b.onerror=function(){a._threeJsTexture=null;a._textureLoadingError=!0;a._triedToLoad=!0;a._onTextureLoadErrorCallback&&a._onTextureLoadErrorCallback(a._chunkID)};
b.send()};f.prototype.getChunkTextureData=function(){return{texture:this._threeJsTexture,origin:this._originWC,valid:!this._textureLoadingError}};f.prototype.getTextureFilepath=function(){return this._filepath};f.prototype.loadingError=function(){return this._textureLoadingError};f.prototype.onTextureLoaded=function(a){this._onTextureLoadedCallback=a};f.prototype.onTextureLoadError=function(a){this._onTextureLoadErrorCallback=a};var l=function(a,b,c,e){this._chunks={};this._datatype=e;this._workingDir=
c;this._matrix3DSize=b;this._resolutionLevel=a;this._chunkSizeLvlZero=1;this._voxelPerSide=64;this._sizeChunkWC=this._chunkSizeLvlZero/Math.pow(2,this._resolutionLevel);this._createFakeTexture();this._chunkCounter={toBeLoaded:0,loaded:0,failled:0};this._onChunksLoadedCallback=null};l.prototype._initChunkFromIndex3D=function(a){var b=this,c=this.getKeyFromIndex3D(a);this._chunks[c]=new f(this._resolutionLevel,this._voxelPerSide,this._sizeChunkWC,this._workingDir,c,this._datatype,this._matrix3DSize);
this._chunks[c].onTextureLoaded(function(a){b._countChunks(a,!0)});this._chunks[c].onTextureLoadError(function(a){b._countChunks(a,!1)});this._chunks[c].buildFromIndex3D(a);this._chunkCounter.toBeLoaded++;return this._chunks[c]};l.prototype.getSizeChunkWc=function(){return this._sizeChunkWC};l.prototype.getTextureAtPosition=function(a){a=this.getIndex3DFromWorldPosition(a);return this.getTextureAtIndex3D(a)};l.prototype.getTextureAtIndex3D=function(a){var b=this._fakeTextureData;if(this.isWithinBounds(a)){var c=
this._getChunkIfInCollection(a);c||(c=this._initChunkFromIndex3D(a));c.loadingError()||(b=c.getChunkTextureData())}return b};l.prototype.getIndex3DFromWorldPosition=function(a){return[Math.floor(a[0]/this._sizeChunkWC),Math.floor(a[1]/this._sizeChunkWC),Math.floor(a[2]/this._sizeChunkWC)]};l.prototype.isInCollection=function(a){return this.getKeyFromIndex3D(a)in this._chunks};l.prototype._getChunkIfInCollection=function(a){a=this.getKeyFromIndex3D(a);return a in this._chunks?this._chunks[a]:null};
l.prototype.getKeyFromIndex3D=function(a){return a.join("_")};l.prototype.isWithinBounds=function(a){return 0>a[0]||a[0]>=this._matrix3DSize[0]||0>a[1]||a[1]>=this._matrix3DSize[1]||0>a[2]||a[2]>=this._matrix3DSize[2]?!1:!0};l.prototype._createFakeTexture=function(){this._fakeTextureData={texture:new THREE.DataTexture(new Uint8Array(1),1,1,THREE.LuminanceFormat,THREE.UnsignedByteType),origin:new THREE.Vector3(0,0,0),validity:!1}};l.prototype._get8ClosestToPositions=function(a){var b=this.getIndex3DFromWorldPosition(a);
a=[Math.abs(a[0]%this._sizeChunkWC)>this._sizeChunkWC/2?b[0]+Math.sign(a[0]):b[0]-Math.sign(a[0]),Math.abs(a[1]%this._sizeChunkWC)>this._sizeChunkWC/2?b[1]+Math.sign(a[1]):b[1]-Math.sign(a[1]),Math.abs(a[2]%this._sizeChunkWC)>this._sizeChunkWC/2?b[2]+Math.sign(a[2]):b[2]-Math.sign(a[2])];return[[b[0],b[1],b[2]],[b[0],b[1],a[2]],[b[0],a[1],b[2]],[b[0],a[1],a[2]],[a[0],b[1],b[2]],[a[0],b[1],a[2]],[a[0],a[1],b[2]],[a[0],a[1],a[2]]]};l.prototype.get8ClosestTextureData=function(a){var b=0,c=[],e=[],u=
[],d=[],g=this;this._get8ClosestToPositions(a).forEach(function(a){a=g.getTextureAtIndex3D(a);a.valid?(c.push(a.texture),u.push(a.origin)):(e.push(a.texture),d.push(a.origin))});b=c.length;return{textures:c.concat(e),origins:u.concat(d),nbValid:b}};l.prototype._countChunks=function(a,b){this._chunkCounter.loaded+=+b;this._chunkCounter.failled+=+!b;this._chunkCounter.loaded+this._chunkCounter.failled==this._chunkCounter.toBeLoaded&&(console.log("\x3e\x3e All required chunks are loaded"),this._onChunksLoadedCallback&&
this._onChunksLoadedCallback())};l.prototype.onChunkLoaded=function(a){this._onChunksLoadedCallback=a};var w=function(){};w.loadTextFile=function(a,b,c){var e="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");e.open("GET",a,!0);e.onload=function(){var a;4==e.readyState&&(a=e.status,200==a?b&&b(e.responseText):c&&c(a))};e.onerror=function(a){c&&c(status)};e.send()};w.loadCompressedTextFile=function(a,b,c){if(w.isPakoAvailable()){var e=new XMLHttpRequest;e.open("GET",
a,!0);e.responseType="arraybuffer";e.onload=function(a){if(a=e.response){a=pako.inflate(a).buffer;a=new Blob([a]);var d=new FileReader;d.onload=function(a){b&&b(a.target.result)};d.onerror=function(a){c&&c(a)};d.readAsText(a)}};e.onerror=function(b){console.error("Can't find the file "+a);c&&c(status)};e.send(null)}else c("Pako lib is not available, please include it to your project.")};w.isPakoAvailable=function(){var a=!0;try{pako}catch(b){console.warn(b),a=!1}return a};var t=function(){this._chunkCollections=
[];this._workingDir="";this._resolutionLevel=0;this._cubeHull=this.onReadyCallback=null;this._chunkSize=[64,64,64];this._onConfigErrorCallback=null};t.prototype.onReady=function(a){this.onReadyCallback=a};t.prototype.loadConfig=function(a){var b=this,c=a.url;w.loadTextFile(c,function(e){b._workingDir=c.substring(0,Math.max(c.lastIndexOf("/"),c.lastIndexOf("\\")));b._loadConfigDescription(a.datatype,JSON.parse(e))},function(a){console.error("Could not load config file "+c);b._onConfigErrorCallback&&
b._onConfigErrorCallback(c,0)})};t.prototype._loadConfigDescription=function(a,b){var c=this;b=b.scales;0<b.length&&b.sort(function(a,b){return a.resolution[0]>b.resolution[0]?-1:1});this._determineChunkSize(b);this._computeCubeHull(b);b.forEach(function(b,d){c._addChunkCollectionLevel(d,b.size,a)});if(this.onReadyCallback)this.onReadyCallback()};t.prototype._addChunkCollectionLevel=function(a,b,c){this._chunkCollections.push(new l(a,[Math.ceil(b[0]/this._chunkSize[0]),Math.ceil(b[1]/this._chunkSize[1]),
Math.ceil(b[2]/this._chunkSize[2])],this._workingDir,c))};t.prototype.setResolutionLevel=function(a){a=Math.round(a);0<=a&&a<this._chunkCollections.length&&(this._resolutionLevel=a)};t.prototype.getCurrentResolutionLevel=function(){return this._resolutionLevel};t.prototype.getCurrentChunkSizeWc=function(){return this._chunkCollections[this._resolutionLevel].getSizeChunkWc()};t.prototype.getChunkSizeWcByLvl=function(a){return this._chunkCollections[a].getSizeChunkWc()};t.prototype.get8ClosestTextureData=
function(a){return this._chunkCollections[this._resolutionLevel].get8ClosestTextureData(a)};t.prototype.get8ClosestTextureDataByLvl=function(a,b){return this._chunkCollections[b].get8ClosestTextureData(a)};t.prototype._determineChunkSize=function(a){this._chunkSize=a[0].chunk_sizes[0]};t.prototype._computeCubeHull=function(a){this._cubeHull=[a[0].size[0]/64,a[0].size[1]/64,a[0].size[2]/64]};t.prototype.getCubeHull=function(){return this._cubeHull.slice()};t.prototype.onConfigError=function(a){this._onConfigErrorCallback=
a};h=function(){this._rePattern=/(\d)[\/]([-]?[0-9]*[.]?[0-9]+)[,]([-]?[0-9]*[.]?[0-9]+)[,]([-]?[0-9]*[.]?[0-9]+)[\/]([-]?[0-9]*[.]?[0-9]+)[,]([-]?[0-9]*[.]?[0-9]+)[,]([-]?[0-9]*[.]?[0-9]+)/g};h.prototype.getRawHash=function(){return window.location.hash.substr(1)};h.prototype.getHashInfo=function(){var a=this._rePattern.exec(this.getRawHash());return a?{resolutionLvl:parseInt(a[1]),position:{x:parseFloat(a[2]),y:parseFloat(a[3]),z:parseFloat(a[4])},rotation:{x:parseFloat(a[5]),y:parseFloat(a[6]),
z:parseFloat(a[7])}}:null};h.prototype.setHashInfo=function(a){isNaN(a.position.x)||isNaN(a.position.y)||isNaN(a.position.z)||isNaN(a.rotation.x)||isNaN(a.rotation.y)||isNaN(a.rotation.z)||(window.location.hash=a.resolutionLvl+"/"+a.position.x+","+a.position.y+","+a.position.z+"/"+a.rotation.x+","+a.rotation.y+","+a.rotation.z)};var k=function(a,b,c){this._isPerspective=!1;this._objectSize=c;this._config=this._camera=null;this._near=.1;this._far=1E3;this._defaultFov=30;this._viewName="";this._originToLookAt=
new THREE.Vector3(0,0,0);this._control=null;this._renderer=b;this._scene=a;this._mouse={x:0,y:0};this._mouseInView=!1;this._backgroundColor=null;this._windowSize={width:window.innerWidth,height:window.innerHeight}};k.prototype.setOriginToLookAt=function(a,b,c){this._originToLookAt.set(a,b,c)};k.prototype.initTopLeft=function(){this._config={left:0,bottom:.5,width:.5,height:.5,position:[-this._objectSize,0,0],up:[-1,0,0]};this._viewName="top_left";this._backgroundColor=(new THREE.Color).setRGB(.8,
.8,.8)};k.prototype.initTopRight=function(){this._config={left:.5,bottom:.5,width:.5,height:.5,position:[0,-this._objectSize,0],up:[0,-1,0]};this._viewName="top_right";this._backgroundColor=(new THREE.Color).setRGB(.9,.9,.9)};k.prototype.initBottomLeft=function(){this._config={left:0,bottom:0,width:.5,height:.5,position:[0,0,-this._objectSize],up:[0,1,0]};this._viewName="bottom_left";this._backgroundColor=(new THREE.Color).setRGB(.9,.9,.9)};k.prototype.initBottomRight=function(){this._config={left:.5,
bottom:0,width:.5,height:.5,position:[-this._objectSize/2,this._objectSize/2,-this._objectSize/3],up:[0,0,-1]};this._viewName="bottom_right";this._backgroundColor=(new THREE.Color).setRGB(.97,.97,.97)};k.prototype.initOrthoCamera=function(){this._isPerspective=!1;this._camera=new THREE.OrthographicCamera(window.innerWidth/-360,window.innerWidth/360,window.innerHeight/360,window.innerHeight/-360);this._camera.left_orig=window.innerWidth/-360;this._camera.right_orig=window.innerWidth/360;this._camera.top_orig=
window.innerHeight/360;this._camera.bottom_orig=window.innerHeight/-360;this._initCameraSettings()};k.prototype.initPerspectiveCamera=function(){this._isPerspective=!0;this._camera=new THREE.PerspectiveCamera(this._defaultFov,window.innerWidth/window.innerHeight,this._near,this._far);this._initCameraSettings()};k.prototype._initCameraSettings=function(){this._camera.position.x=this._config.position[0];this._camera.position.y=this._config.position[1];this._camera.position.z=this._config.position[2];
this._camera.up.x=this._config.up[0];this._camera.up.y=this._config.up[1];this._camera.up.z=this._config.up[2];this._camera.fov=this._defaultFov;this._camera.lookAt(this._originToLookAt)};k.prototype.addTrackballControl=function(a,b){this._control=new THREE.TrackballControls(this._camera,b);this._control.rotateSpeed=5;this._control.staticMoving=!0;this._control.zoomSpeed=.3;this._control.panSpeed=1;this._control.addEventListener("change",this.renderView.bind(this))};k.prototype.setBackgroundColor=
function(a){this._backgroundColor=a};k.prototype.renderView=function(){var a=Math.floor(window.innerWidth*this._config.left),b=Math.floor(window.innerHeight*this._config.bottom),c=Math.floor(window.innerWidth*this._config.width),e=Math.floor(window.innerHeight*this._config.height);this._renderer.setViewport(a,b,c,e);this._renderer.setScissor(a,b,c,e);this._renderer.setScissorTest(!0);this._renderer.setClearColor(this._backgroundColor);this._camera.aspect=c/e;this._camera.updateProjectionMatrix();
this._renderer.render(this._scene,this._camera)};k.prototype.useRelativeCoordinatesOf=function(a){a.add(this._camera)};k.prototype.updateOrthoCamFrustrum=function(a){this._camera.left=this._camera.left_orig*a;this._camera.right=this._camera.right_orig*a;this._camera.top=this._camera.top_orig*a;this._camera.bottom=this._camera.bottom_orig*a};k.prototype.updateLookAt=function(a){this._camera.lookAt(a.clone());this._control&&(this._control.target=a.clone())};k.prototype.updateControl=function(){this._control.update()};
k.prototype.enableControl=function(){this._control&&!this._control.enabled&&(this._control.enabled=!0)};k.prototype.disableControl=function(){this._control&&this._control.enabled&&(this._control.enabled=!1)};k.prototype.isUsingControl=function(){return!!this._control};k.prototype.isInViewWindow=function(a,b){return a>this._config.left&&b>this._config.bottom&&a<this._config.left+this._config.width&&b<this._config.bottom+this._config.height};k.prototype.enableLayer=function(a){this._camera.layers.enable(a)};
k.prototype.disableLayer=function(a){this._camera.layers.disable(a)};k.prototype.getCamera=function(){return this._camera};k.prototype.updateRatio=function(a,b){this._isPerspective?(this._camera.aspect=a/b,this._camera.updateProjectionMatrix()):(a=this._windowSize.width/window.innerWidth,b=this._windowSize.height/window.innerHeight,this._camera.left/=a,this._camera.right/=a,this._camera.top/=b,this._camera.bottom/=b);this._windowSize.width=window.innerWidth;this._windowSize.height=window.innerHeight};
k.prototype.isPerspective=function(){return this._isPerspective};k.prototype.getConfigParam=function(a){if(a in this._config)return this._config[a];console.warn(a+" param does not exist in the config.");return null};var x=function(a){this._sphere=new THREE.Object3D;var b=new THREE.CircleGeometry(a,64),c=new THREE.CircleGeometry(a,64),e=new THREE.CircleGeometry(a,64),d=new THREE.LineBasicMaterial({color:16724787,linewidth:1.5}),g=new THREE.LineBasicMaterial({color:60238,linewidth:1.5}),f=new THREE.LineBasicMaterial({color:35071,
linewidth:1.5});b.vertices.shift();c.vertices.shift();e.vertices.shift();d=new THREE.Line(b,d);d.name="xCircle";b.rotateY(Math.PI/2);b=new THREE.Line(c,g);b.name="yCircle";c.rotateX(-Math.PI/2);c=new THREE.Line(e,f);c.name="zCircle";this._sphere=new THREE.Object3D;this._sphere.add(d);this._sphere.add(b);this._sphere.add(c);c=new THREE.Geometry;c.vertices.push(new THREE.Vector3(-a,0,0),new THREE.Vector3(a,0,0));c=new THREE.Line(c,new THREE.LineBasicMaterial({color:16724787,linewidth:1.5}));e=new THREE.Geometry;
e.vertices.push(new THREE.Vector3(0,-a,0),new THREE.Vector3(0,a,0));e=new THREE.Line(e,new THREE.LineBasicMaterial({color:60238,linewidth:1.5}));f=new THREE.Geometry;f.vertices.push(new THREE.Vector3(0,0,-a),new THREE.Vector3(0,0,a));f=new THREE.Line(f,new THREE.LineBasicMaterial({color:35071,linewidth:1.5}));this._sphere.add(c);this._sphere.add(e);this._sphere.add(f);f=new THREE.TextureLoader;c=f.load("textures/left.png");d=f.load("textures/right.png");g=f.load("textures/anterior.png");b=f.load("textures/posterior.png");
e=f.load("textures/superior.png");f=f.load("textures/inferior.png");c=new THREE.Sprite(new THREE.SpriteMaterial({map:c}));d=new THREE.Sprite(new THREE.SpriteMaterial({map:d}));g=new THREE.Sprite(new THREE.SpriteMaterial({map:g}));b=new THREE.Sprite(new THREE.SpriteMaterial({map:b}));e=new THREE.Sprite(new THREE.SpriteMaterial({map:e}));f=new THREE.Sprite(new THREE.SpriteMaterial({map:f}));a*=1.4;c.position.set(a,0,0);d.position.set(-a,0,0);g.position.set(0,a,0);b.position.set(0,-a,0);e.position.set(0,
0,-a);f.position.set(0,0,a);this._sphere.add(c);this._sphere.add(d);this._sphere.add(g);this._sphere.add(b);this._sphere.add(e);this._sphere.add(f);this._sphere.children.forEach(function(a){a.layers.enable(0);a.layers.enable(1)})};x.prototype.addTo=function(a){a.add(this._sphere)};x.prototype.rescale=function(a){this._sphere.scale.x=a;this._sphere.scale.y=a;this._sphere.scale.z=a};x.prototype.rescaleFromResolutionLvl=function(a){a=1/Math.pow(2,a);this._sphere.scale.x=a;this._sphere.scale.y=a;this._sphere.scale.z=
a};x.prototype.setPosition=function(a){this._sphere.position.x=a.x;this._sphere.position.y=a.y;this._sphere.position.z=a.z};x.prototype.toggle=function(){this._sphere.visible=!this._sphere.visible};var r=function(a){this._quadViews=a;this._windowSize={width:window.innerWidth,height:window.innerHeight};this._mouse={x:0,y:0};this._mouseLastPosition={x:-1,y:-1};this._mouseDistance={x:0,y:0};this._indexViewMouseDown=this._indexCurrentView=-1;this._shiftKeyPressed=this._tKeyPressed=this._rKeyPressed=this._mousePressed=
!1;document.addEventListener("mousemove",this._onMouseMove.bind(this),!1);document.addEventListener("mousedown",this._onMouseDown.bind(this),!1);document.addEventListener("mouseup",this._onMouseUp.bind(this),!1);document.addEventListener("keydown",this._onKeyDown.bind(this),!1);document.addEventListener("keyup",this._onKeyUp.bind(this),!1);this._multiplaneContainer=this._onDonePlayingCallback=this._onArrowDownCallback=this._onArrowUpCallback=this._onScrollViewCallback=this._onGrabViewTransverseRotateCallback=
this._onGrabViewRotateCallback=this._onGrabViewTranslateCallback=null;this._raycaster=new THREE.Raycaster;this._onClickPlaneCallback={perspective:null,ortho:null}};r.prototype.updateWindowSize=function(a,b){this._windowSize.width=a;this._windowSize.height=b;this._quadViews.forEach(function(a){a.updateRatio()})};r.prototype._onMouseMove=function(a){this._mouse.x=a.clientX/this._windowSize.width;this._mouse.y=1-a.clientY/this._windowSize.height;this._manageQuadViewsMouseActivity();if(this._mousePressed){this._mouseDistance.x=
(this._mouse.x-this._mouseLastPosition.x)*this._windowSize.width/100;this._mouseDistance.y=(this._mouse.y-this._mouseLastPosition.y)*this._windowSize.height/100;if(this._rKeyPressed){var b={x:this._indexViewMouseDown%2*.5+.25,y:.5*(1<this._indexViewMouseDown?0:1)+.25};a=(new THREE.Vector3(this._mouseLastPosition.x-b.x,this._mouseLastPosition.y-b.y,this._mouseLastPosition.z-b.z)).normalize();var c=(new THREE.Vector3(this._mouse.x-b.x,this._mouse.y-b.y,this._mouse.z-b.z)).normalize(),b=Math.acos(a.dot(c));
a=Math.sign(a.cross(c).z);this._onGrabViewRotateCallback&&this._onGrabViewRotateCallback(b,a,this._indexViewMouseDown)}else this._tKeyPressed?this._onGrabViewTransverseRotateCallback&&this._onGrabViewTransverseRotateCallback(this._mouseDistance,this._indexViewMouseDown):this._onGrabViewTranslateCallback&&this._onGrabViewTranslateCallback(this._mouseDistance,this._indexViewMouseDown);this._mouseLastPosition.x=this._mouse.x;this._mouseLastPosition.y=this._mouse.y}};r.prototype._onMouseDown=function(a){this._mousePressed=
!0;this._indexViewMouseDown=this._indexCurrentView;this._shiftKeyPressed&&this._intersectMultiplane(a);this._mouseLastPosition.x=this._mouse.x;this._mouseLastPosition.y=this._mouse.y};r.prototype._onMouseUp=function(a){this._mousePressed=!1;this._indexViewMouseDown=-1;this._mouseDistance.x=0;this._mouseDistance.y=0;this._onDonePlayingCallback&&this._onDonePlayingCallback()};r.prototype._onKeyDown=function(a){switch(a.key){case "r":this._rKeyPressed=!0;break;case "t":this._tKeyPressed=!0;break;case "Shift":this._shiftKeyPressed=
!0;break;case "ArrowDown":this._onArrowDownCallback&&this._onArrowDownCallback(this._indexCurrentView);break;case "ArrowUp":this._onArrowUpCallback&&this._onArrowUpCallback(this._indexCurrentView)}};r.prototype._onKeyUp=function(a){switch(a.key){case "r":this._rKeyPressed=!1;break;case "t":this._tKeyPressed=!1;break;case "Shift":this._shiftKeyPressed=!1}this._onDonePlayingCallback&&this._onDonePlayingCallback()};r.prototype._manageQuadViewsMouseActivity=function(){var a=this,b=this._mouse.x,c=this._mouse.y;
this._quadViews.forEach(function(e,d){e.isInViewWindow(b,c)?(a._indexCurrentView=d,e.enableControl()):e.disableControl()})};r.prototype.onGrabViewTranslate=function(a){this._onGrabViewTranslateCallback=a};r.prototype.onGrabViewRotate=function(a){this._onGrabViewRotateCallback=a};r.prototype.onGrabViewTransverseRotate=function(a){this._onGrabViewTransverseRotateCallback=a};r.prototype.onArrowDown=function(a){this._onArrowDownCallback=a};r.prototype.onArrowUp=function(a){this._onArrowUpCallback=a};
r.prototype.onDonePlaying=function(a){this._onDonePlayingCallback=a};r.prototype.setMultiplaneContainer=function(a){this._multiplaneContainer=a};r.prototype._intersectMultiplane=function(){var a=1/this._quadViews[this._indexViewMouseDown].getConfigParam("width"),b=1/this._quadViews[this._indexViewMouseDown].getConfigParam("height"),c=this._quadViews[this._indexViewMouseDown].getConfigParam("left"),e=this._quadViews[this._indexViewMouseDown].getConfigParam("bottom"),a=new THREE.Vector2(2*(this._mouse.x*
a-c*a)-1,2*(this._mouse.y*b-e*b)-1);this._raycaster.setFromCamera(a,this._quadViews[this._indexViewMouseDown].getCamera());a=this._raycaster.intersectObject(this._multiplaneContainer,!0);a.length&&(this._quadViews[this._indexViewMouseDown].isPerspective()?this._onClickPlaneCallback.perspective&&this._onClickPlaneCallback.perspective(a[0].point):this._onClickPlaneCallback.ortho&&this._onClickPlaneCallback.ortho(a[0].point))};r.prototype.onClickPlane=function(a,b){a in this._onClickPlaneCallback?this._onClickPlaneCallback[a]=
b:console.warn('The camera type must be "perspective" or "ortho".')};var v=function(){this._defaultMapFolder="colormaps/";this._defaultMaps="plum.png thermal.png blue_klein.png blue_teal.png rainbow.png rainbow_alpha.png".split(" ");this._colorMaps={};this._onColormapUpdateCallback=null;this._currentColormap={id:"none",colormap:null};this._isEnabled=!1;this._textureLoader=new THREE.TextureLoader;this._colorMaps.none=null;this._loadDefaultColormaps()};v.prototype.loadColormap=function(a,b){b=void 0===
b?!0:b;var c=this,e=(new String(a)).substring(a.lastIndexOf("/")+1);-1!=e.lastIndexOf(".")&&(e=e.substring(0,e.lastIndexOf(".")));this._textureLoader.load(a,function(a){c._colorMaps[e]=a;b&&(c._currentColormap.id=e,c._currentColormap.colormap=a);c._onColormapUpdateCallback&&c._onColormapUpdateCallback()},function(a){},function(b){console.error("Failed to load "+a)})};v.prototype._loadDefaultColormaps=function(){var a=this;this._defaultMaps.forEach(function(b,c){a.loadColormap(a._defaultMapFolder+
b,!1)})};v.prototype.getCurrentColorMap=function(){return this._currentColormap};v.prototype.isColormappingEnabled=function(){return this._isEnabled};v.prototype.enableColorMapping=function(){this._isEnabled=!0};v.prototype.disableColorMapping=function(){this._isEnabled=!1};v.prototype.getAvailableColormaps=function(){return Object.keys(this._colorMaps)};v.prototype.useColormap=function(a){return this._colorMaps.hasOwnProperty(a)?(this._currentColormap.id=a,this._currentColormap.colormap=this._colorMaps[a],
"none"==a?this.disableColorMapping():this.enableColorMapping(),!0):!1};v.prototype.onColormapUpdate=function(a){this._onColormapUpdateCallback=a};var p=function(a,b){this._plane=new THREE.Object3D;this._plane.name="projection plane";this._subPlaneSize=a/Math.sqrt(2);this._subPlanes=[];this._shaderMaterials=[];this._subPlaneDim={row:7,col:15};this._colormapManager=b;this._levelManager=null;this._resolutionLevel=0;this._buildSubPlanes()};p.prototype._buildSubPlanes=function(){for(var a=new THREE.PlaneBufferGeometry(this._subPlaneSize,
this._subPlaneSize,1),b=new THREE.DataTexture(new Uint8Array(1),1,1,THREE.LuminanceFormat,THREE.UnsignedByteType),c=new THREE.Vector3(0,0,0),b=new THREE.ShaderMaterial({uniforms:{nbChunks:{type:"i",value:0},textures:{type:"t",value:[b,b,b,b,b,b,b,b]},textureOrigins:{type:"v3v",value:[c,c,c,c,c,c,c,c]},chunkSize:{type:"f",value:1},colorMap:{type:"t",value:this._colormapManager.getCurrentColorMap().colormap},useColorMap:{type:"b",value:this._colormapManager.isColormappingEnabled()}},vertexShader:"uniform float chunkSize;\nuniform sampler2D colorMap;\nvarying vec2 vUv;\nvarying vec4 worldCoord;\nvoid main()\n{\n  vUv \x3d uv;\n  vec4 mvPosition \x3d modelViewMatrix * vec4( position, 1.0 );\n  gl_Position \x3d projectionMatrix * mvPosition;\n  worldCoord \x3d modelMatrix * vec4( position, 1.0 );\n}\n",
fragmentShader:"const int maxNbChunks \x3d 8;\nuniform int nbChunks;\nuniform sampler2D textures[maxNbChunks];\nuniform vec3 textureOrigins[maxNbChunks];\nuniform sampler2D colorMap;\nuniform bool useColorMap;\nuniform float chunkSize;\nvarying vec4 worldCoord;\nvarying vec2 vUv;\nbool isNan(float val)\n{\n  return (val \x3c\x3d 0.0 || 0.0 \x3c\x3d val) ? false : true;\n}\nbool isInsideChunk(in vec3 chunkPosition){\n  return !( chunkPosition.x\x3c0.0 || chunkPosition.x\x3e\x3d1.0 ||\n            chunkPosition.y\x3c0.0 || chunkPosition.y\x3e\x3d1.0 ||\n            chunkPosition.z\x3c0.0 || chunkPosition.z\x3e\x3d1.0 );\n}\nvoid getColorFrom3DTexture(in sampler2D texture, in vec3 chunkPosition, out vec4 colorFromTexture){\n  float numberOfImagePerStripY \x3d 64.0;\n  float numberOfPixelPerSide \x3d 64.0;\n  float yOffsetNormalized \x3d float(int(chunkPosition.z * numberOfImagePerStripY)) / numberOfImagePerStripY;\n  float stripX \x3d chunkPosition.x;\n  float stripY \x3d chunkPosition.y / numberOfImagePerStripY + yOffsetNormalized;\n  vec2 posWithinStrip \x3d vec2(stripX, stripY);\n  colorFromTexture \x3d texture2D(texture, posWithinStrip);\n}\nvec3 worldCoord2ChunkCoord(vec4 world, vec3 textureOrigin, float chunkSize){\n  vec3 chunkSystemCoordinate \x3d vec3((textureOrigin.x - world.x)*(-1.0)/chunkSize,\n                                    1.0 - (textureOrigin.y - world.y)*(-1.0)/chunkSize,\n                                    1.0 - (textureOrigin.z - world.z)*(-1.0)/chunkSize);\n  return chunkSystemCoordinate;\n}\nvoid main( void ) {\n  vec2 shaderPos \x3d vUv;\n  vec4 color \x3d vec4(1.0, 0.0 , 0.0, 1.0);\n  vec3 chunkPosition;\n  bool hasColorFromChunk \x3d false;\n  if(nbChunks \x3e\x3d 1){\n    chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[0], chunkSize);\n    if( isInsideChunk(chunkPosition) ){\n      getColorFrom3DTexture(textures[0], chunkPosition, color);\n      hasColorFromChunk \x3d true;\n    }\n    if(nbChunks \x3e\x3d 2){\n      chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[1], chunkSize);\n      if( isInsideChunk(chunkPosition) ){\n        getColorFrom3DTexture(textures[1], chunkPosition, color);\n        hasColorFromChunk \x3d true;\n      }\n      if(nbChunks \x3e\x3d 3){\n        chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[2], chunkSize);\n        if( isInsideChunk(chunkPosition) ){\n          getColorFrom3DTexture(textures[2], chunkPosition, color);\n          hasColorFromChunk \x3d true;\n        }\n        if(nbChunks \x3e\x3d 4){\n          chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[3], chunkSize);\n          if( isInsideChunk(chunkPosition) ){\n            getColorFrom3DTexture(textures[3], chunkPosition, color);\n            hasColorFromChunk \x3d true;\n          }\n          if(nbChunks \x3e\x3d 5){\n            chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[4], chunkSize);\n            if( isInsideChunk(chunkPosition) ){\n              getColorFrom3DTexture(textures[4], chunkPosition, color);\n              hasColorFromChunk \x3d true;\n            }\n            if(nbChunks \x3e\x3d 6){\n              chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[5], chunkSize);\n              if( isInsideChunk(chunkPosition) ){\n                getColorFrom3DTexture(textures[5], chunkPosition, color);\n                hasColorFromChunk \x3d true;\n              }\n              if(nbChunks \x3e\x3d 7){\n                chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[6], chunkSize);\n                if( isInsideChunk(chunkPosition) ){\n                  getColorFrom3DTexture(textures[6], chunkPosition, color);\n                  hasColorFromChunk \x3d true;\n                }\n                if(nbChunks \x3d\x3d 8){\n                  chunkPosition \x3d worldCoord2ChunkCoord(worldCoord, textureOrigins[7], chunkSize);\n                  if( isInsideChunk(chunkPosition) ){\n                    getColorFrom3DTexture(textures[7], chunkPosition, color);\n                    hasColorFromChunk \x3d true;\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n  if(hasColorFromChunk){\n    if(useColorMap){\n      vec2 colorToPosition \x3d vec2(color.r, 0.5);\n      vec4 colorFromColorMap \x3d texture2D(colorMap, colorToPosition);\n      if(colorFromColorMap.a \x3e 0.0){\n        gl_FragColor \x3d colorFromColorMap;\n      }else{\n        discard;\n      }\n    }else{\n      gl_FragColor \x3d color;\n    }\n  }else{\n    discard;\n  }\n}\n",
side:THREE.DoubleSide,transparent:!0}),c=0;c<this._subPlaneDim.row;c++)for(var e=0;e<this._subPlaneDim.col;e++){var d=b.clone(),f=new THREE.Mesh(a,d);f.position.set(-this._subPlaneDim.col*this._subPlaneSize/2+e*this._subPlaneSize+this._subPlaneSize/2,-this._subPlaneDim.row*this._subPlaneSize/2+c*this._subPlaneSize+this._subPlaneSize/2,0);this._plane.add(f);this._subPlanes.push(f);this._shaderMaterials.push(d)}};p.prototype.setLevelManager=function(a){this._levelManager=a};p.prototype.setMeshColor=
function(a){this._subPlanes[0].material.color=a};p.prototype.updateUniforms=function(){for(var a=this._subPlaneDim.row*this._subPlaneDim.col,b,c=0;c<a;c++)b=this._subPlanes[c].localToWorld(new THREE.Vector3(0,0,0)),b=this._levelManager.get8ClosestTextureDataByLvl([b.x,b.y,b.z],this._resolutionLevel),this._updateSubPlaneUniform(c,b)};p.prototype.printSubPlaneCenterWorld=function(){for(var a=this._subPlaneDim.row*this._subPlaneDim.col,b=0;b<a;b++)this._subPlanes[b].localToWorld(new THREE.Vector3(0,
0,0))};p.prototype._updateSubPlaneUniform=function(a,b){var c=this._levelManager.getChunkSizeWcByLvl(this._resolutionLevel);a=this._shaderMaterials[a].uniforms;a.nbChunks.value=b.nbValid;a.textures.value=b.textures;a.textureOrigins.value=b.origins;a.chunkSize.value=c;a.useColorMap.value=this._colormapManager.isColormappingEnabled();a.colorMap.value=this._colormapManager.getCurrentColorMap().colormap};p.prototype.getPlane=function(){return this._plane};p.prototype.updateScaleFromRezLvl=function(a){0>
a&&(a=0);this._resolutionLevel=a;a=1/Math.pow(2,this._resolutionLevel);this._plane.scale.x=a;this._plane.scale.y=a;this._plane.scale.z=a;this._plane.updateMatrixWorld();this.updateUniforms()};p.prototype.getWorldNormal=function(){return this._getWorldVectorNormalized(new THREE.Vector3(0,0,1))};p.prototype.getWorldVectorU=function(){return this._getWorldVectorNormalized(new THREE.Vector3(1,0,0))};p.prototype.getWorldVectorV=function(){return this._getWorldVectorNormalized(new THREE.Vector3(0,1,0))};
p.prototype._getWorldVectorNormalized=function(a){var b=(new THREE.Quaternion).copy(this._plane.quaternion);a=a.clone();a.applyQuaternion(b).normalize();return a};p.prototype.getWorldDiagonal=function(){return Math.sqrt(Math.pow(this._subPlaneDim.row,2)+Math.pow(this._subPlaneDim.col,2))*this._plane.scale.x};p.prototype.enableLayer=function(a){this._subPlanes.forEach(function(b){b.layers.enable(a)})};p.prototype.disableLayer=function(a){this._subPlanes.forEach(function(b){b.layers.disable(a)})};var q=
function(a,b){this._colormapManager=a;this._parent=b;this._projectionPlanesHiRez=[];this._projectionPlanesLoRez=[];this._addOrthoPlanes(this._projectionPlanesHiRez);this._addOrthoPlanes(this._projectionPlanesLoRez)};q.prototype._addOrthoPlanes=function(a){var b=new p(1,this._colormapManager);b.setMeshColor(new THREE.Color(153));a.push(b);this._parent.add(b.getPlane());b=new p(1,this._colormapManager);a.push(b);b.getPlane().rotateX(Math.PI/2);this._parent.add(b.getPlane());b=new p(1,this._colormapManager);
b.setMeshColor(new THREE.Color(10027008));a.push(b);b.getPlane().rotateY(Math.PI/2);b.getPlane().rotateZ(Math.PI/2);this._parent.add(b.getPlane())};q.prototype.enableLayerHiRez=function(a){this._enableLayerPlaneArray(a,this._projectionPlanesHiRez)};q.prototype.enableLayerLoRez=function(a){this._enableLayerPlaneArray(a,this._projectionPlanesLoRez)};q.prototype._enableLayerPlaneArray=function(a,b){b.forEach(function(b){b.enableLayer(a)})};q.prototype.disableLayerHiRez=function(a){this._disableLayerPlaneArray(a,
this._projectionPlanesHiRez)};q.prototype.disableLayerLoRez=function(a){this._disableLayerPlaneArray(a,this._projectionPlanesLoRez)};q.prototype._disableLayerPlaneArray=function(a,b){b.forEach(function(b){b.disableLayer(a)})};q.prototype.setLevelManager=function(a){this._setLevelManagerPlaneArray(a,this._projectionPlanesHiRez);this._setLevelManagerPlaneArray(a,this._projectionPlanesLoRez)};q.prototype._setLevelManagerPlaneArray=function(a,b){b.forEach(function(b){b.setLevelManager(a)})};q.prototype.updateScaleFromRezLvl=
function(a){this._updateScaleFromRezLvlPlaneArray(a,this._projectionPlanesHiRez);this._updateScaleFromRezLvlPlaneArray(a-2,this._projectionPlanesLoRez)};q.prototype._updateScaleFromRezLvlPlaneArray=function(a,b){b.forEach(function(b){b.updateScaleFromRezLvl(a)})};q.prototype.updateUniforms=function(){this._updateUniformsPlaneArray(this._projectionPlanesHiRez);this._updateUniformsPlaneArray(this._projectionPlanesLoRez)};q.prototype._updateUniformsPlaneArray=function(a){a.forEach(function(a){a.updateUniforms()})};
q.prototype.getWorldDiagonalHiRez=function(){return this._projectionPlanesHiRez[0].getWorldDiagonal()};q.prototype.getWorldVectorN=function(a){return this._projectionPlanesHiRez[a].getWorldNormal()};q.prototype.getWorldVectorU=function(a){return this._projectionPlanesHiRez[a].getWorldVectorU()};q.prototype.getWorldVectorV=function(a){return this._projectionPlanesHiRez[a].getWorldVectorV()};var n=function(){this._shapeData=this._tempResult=this._stackIndex=this._stack=null};n.prototype.copy=function(a){this._stack=
a._stack;this._stackIndex=a._stackIndex;this._tempResult=a._tempResult;this._shapeData=a._shapeData};n.prototype.parse=function(a){this._parseRawData(a);this._arrangeData()};n.prototype._parseRawData=function(a){this._stack=a.trim().split(/\s+/).reverse();this._stackIndex=this._stack.length-1;this._tempResult={};a=this._popStack();var b,c,e,d,f,g;this._tempResult.split=!1;this._tempResult.type="P"===a?"polygon":"L"===a?"line":a;if("polygon"===this._tempResult.type)this._parseSurfProp(),this._tempResult.numVertices=
parseInt(this._popStack(),10),this._parseVertices(),this._parseNormals(),this._tempResult.nitems=parseInt(this._popStack(),10);else if("line"===this._tempResult.type)this._parseSurfProp(),this._tempResult.numVertices=parseInt(this._popStack(),10),this._parseVertices(),this._tempResult.nitems=parseInt(this._popStack(),10);else{this._tempResult.error=!0;this._tempResult.errorMessage='Invalid MNI Object class: must be "polygon" or "line"';return}this._parseColors();this._parseEndIndices();this._parseIndices();
if("polygon"!==this._tempResult.type&&"line"===this._tempResult.type){e=this._tempResult.indices;d=this._tempResult.endIndices;c=this._tempResult.nitems;for(var h=f=g=0;h<c;h++)b=0===h?0:d[h-1],a=d[h],f+=2*(a-b-1);f=new Uint32Array(f);for(h=0;h<c;h++){b=0===h?0:d[h-1];f[g++]=e[b];a=d[h];for(b+=1;b<a-1;b++)f[g++]=e[b],f[g++]=e[b];f[g++]=e[a-1]}this._tempResult.indices=f}};n.prototype._arrangeData=function(){this._shapeData={type:this._tempResult.type,vertices:this._tempResult.vertices,normals:this._tempResult.normals,
colors:this._tempResult.colors,surfaceProperties:this._tempResult.surfaceProperties,split:this._tempResult.split,error:this._tempResult.error,errorMessage:this._tempResult.errorMessage};var a=[this._shapeData.vertices.buffer,this._shapeData.colors.buffer];this._shapeData.normals&&a.push(this._shapeData.normals.buffer);this._shapeData.split?(this._shapeData.shapes=[{indices:this._tempResult.left.indices},{indices:this._tempResult.right.indices}],a.push(this._tempResult.left.indices.buffer,this._tempResult.right.indices.buffer)):
(this._shapeData.shapes=[{indices:this._tempResult.indices}],a.push(this._tempResult.indices.buffer));4===this._shapeData.colors.length&&this._unrollColors()};n.prototype._unrollColors=function(){var a,b,c,e,d=this._shapeData.vertices.length/3*4,f=new Uint8Array(d);a=this._shapeData.colors[0];b=this._shapeData.colors[1];c=this._shapeData.colors[2];e=this._shapeData.colors[3];for(var g=0;g<d;g+=4)f[g]=255*a,f[g+1]=255*b,f[g+2]=255*c,f[g+3]=255*e;this._shapeData.colors=f};n.prototype._parseSurfProp=
function(){"polygon"===this._tempResult.type?this._tempResult.surfaceProperties={ambient:parseFloat(this._popStack()),diffuse:parseFloat(this._popStack()),specularReflectance:parseFloat(this._popStack()),specularScattering:parseFloat(this._popStack()),transparency:parseFloat(this._popStack())}:"line"===this._tempResult.type&&(this._tempResult.surfaceProperties={width:this._popStack()})};n.prototype._parseVertices=function(){for(var a=3*this._tempResult.numVertices,b=new Float32Array(a),c=0;c<a;c++)b[c]=
parseFloat(this._popStack());this._tempResult.vertices=b};n.prototype._parseNormals=function(){for(var a=3*this._tempResult.numVertices,b=new Float32Array(a),c=0;c<a;c++)b[c]=parseFloat(this._popStack());this._tempResult.normals=b};n.prototype._parseColors=function(){var a=parseInt(this._popStack(),10),b,c;if(0===a){b=new Float32Array(4);for(var e=0;4>e;e++)b[e]=parseFloat(this._popStack())}else if(1===a)for(c=4*this._tempResult.num_polygons,b=new Float32Array(c),e=0;e<c;e++)b[e]=parseFloat(this._popStack());
else if(2===a)for(c=4*this._tempResult.numVertices,b=new Float32Array(c),e=0;e<c;e++)b[e]=parseFloat(this._popStack());else this._tempResult.error=!0,this._tempResult.errorMessage="Invalid color flag: "+a;this._tempResult.colorFlag=a;this._tempResult.colors=b};n.prototype._parseEndIndices=function(){for(var a=this._tempResult.nitems,b=new Uint32Array(a),c=0;c<a;c++)b[c]=parseInt(this._popStack(),10);this._tempResult.endIndices=b};n.prototype._parseIndices=function(){for(var a=this._stackIndex+1,b=
new Uint32Array(a),c=0;c<a;c++)b[c]=parseInt(this._popStack(),10);this._tempResult.indices=b};n.prototype._splitHemispheres=function(){var a=this._tempResult.indices.length;this._tempResult.left={indices:new Uint32Array(Array.prototype.slice.call(this._tempResult.indices,0,a/2))};this._tempResult.right={indices:new Uint32Array(Array.prototype.slice.call(this._tempResult.indices,a/2))}};n.prototype._popStack=function(){return this._stack[this._stackIndex--]};n.prototype.getShapeData=function(){return this._shapeData};
n.prototype.getNumberOfShapes=function(){return this._shapeData.shapes.length};n.prototype.getShapeRawIndices=function(a){return 0<=a&&a<this._shapeData.shapes.length?this._shapeData.shapes[a].indices:null};n.prototype.getRawVertices=function(){return this._shapeData.vertices};n.prototype.getRawNormals=function(){return this._shapeData.normals};n.prototype.getRawColors=function(){return this._shapeData.colors};n.prototype.getSurfaceProperties=function(){return this._shapeData.surfaceProperties};var y=
function(a,b){this._container=b;this._meshes={};this._collectionBox=this._configFileDir=null;this._readConfig(a)};y.prototype._readConfig=function(a){var b=this,c=a.url;w.loadTextFile(c,function(a){b._configFileDir=c.substring(0,Math.max(c.lastIndexOf("/"),c.lastIndexOf("\\")))+"/";b._loadConfigDescription(JSON.parse(a))},function(a){console.error("Could not load config file "+c);b._onConfigErrorCallback&&b._onConfigErrorCallback(c,0)})};y.prototype._loadConfigDescription=function(a){var b=this;a.forEach(function(a){var c=
a.url;"near"==a.urlType&&(c=b._configFileDir+c);w.loadTextFile(c,function(c){var e=new n;e.parse(c);c=b._buildMeshFromObjReader(e);c.geometry.computeBoundingBox();c.name=a.id;c.userData.longName=a.name;c.userData.description=a.description;"eulerAngle"in a&&c.rotation.set(a.eulerAngle[0],a.eulerAngle[1],a.eulerAngle[2]);"scale"in a&&c.scale.set(a.scale[0],a.scale[1],a.scale[2]);"position"in a&&c.position.set(a.position[0],a.position[1],a.position[2]);c.layers.enable(0);c.layers.enable(1);b._meshes[a.id]=
c;b._container.add(c);b._updateCollectionBox(c)},function(a){console.error("Could not load mesh file "+c)})})};y.prototype._buildMeshFromObjReader=function(a){var b=new THREE.BufferGeometry,c=a.getShapeRawIndices(0),e=a.getRawVertices(),d=a.getRawNormals(),f=a.getRawColors();b.setIndex(new THREE.BufferAttribute(c,1));b.addAttribute("position",new THREE.BufferAttribute(e,3));b.addAttribute("normal",new THREE.BufferAttribute(d,3,!0));b.addAttribute("color",new THREE.BufferAttribute(f,4,!0));b.computeBoundingSphere();
a=new THREE.MeshPhongMaterial({specular:16777215,shininess:250,side:THREE.DoubleSide,vertexColors:THREE.VertexColors,transparent:!0,opacity:a.getSurfaceProperties().transparency});return new THREE.Mesh(b,a)};y.prototype._updateCollectionBox=function(a){this._collectionBox?this._collectionBox.union(a.geometry.boundingBox):this._collectionBox=a.geometry.boundingBox.clone()};var g=function(a,b){b=void 0===b?0:b;window.addEventListener("resize",this._updateSize.bind(this),!1);this._ready=!1;this._counterRefresh=
0;this._resolutionLevel=b;this._quadViews=[];this._cubeHull3D=this._planeManager=this._quadViewInteraction=null;this._cubeHullSize=[0,0,0];this._onConfigFileErrorCallback=this._onReadyCallback=this._onChangeCallback=this._orientationHelper=null;this._colormapManager=new v;this._guiVar=null;this._datGui=new dat.GUI;this._initUI();this._domContainer=document.getElementById(a);this._scene=new THREE.Scene;a=new THREE.AxisHelper(1);a.layers.enable(1);this._scene.add(a);this._scene.add(new THREE.AmbientLight(4473924));
a=new THREE.DirectionalLight(16777215,.75);a.position.set(200,200,200);a.layers.enable(0);a.layers.enable(1);this._scene.add(a);this._adjustedContainer=new THREE.Object3D;this._annotationContainer=new THREE.Object3D;this._meshContainer=new THREE.Object3D;this._adjustedContainer.add(this._meshContainer);this._adjustedContainer.add(this._annotationContainer);this._scene.add(this._adjustedContainer);this._renderer=new THREE.WebGLRenderer({antialias:!0});this._renderer.setPixelRatio(window.devicePixelRatio);
this._renderer.setSize(window.innerWidth,window.innerHeight);this._domContainer.appendChild(this._renderer.domElement);this._multiplaneContainer=new THREE.Object3D;this._scene.add(this._multiplaneContainer);this._cameraDistance=10;this._windowSize={width:0,height:0};this._stats=this._meshCollection=null;this._initViews();this._levelManager=new t;this._initPlaneManager();this._animate()};g.prototype._initViews=function(){var a=this,b=new k(this._scene,this._renderer,this._cameraDistance);b.initTopLeft();
b.initOrthoCamera();b.useRelativeCoordinatesOf(this._multiplaneContainer);b.enableLayer(0);var c=new k(this._scene,this._renderer,this._cameraDistance);c.initTopRight();c.initOrthoCamera();c.useRelativeCoordinatesOf(this._multiplaneContainer);c.enableLayer(0);var e=new k(this._scene,this._renderer,this._cameraDistance);e.initBottomLeft();e.initOrthoCamera();e.useRelativeCoordinatesOf(this._multiplaneContainer);e.enableLayer(0);var d=new k(this._scene,this._renderer,this._cameraDistance);d.initBottomRight();
d.initPerspectiveCamera();d.enableLayer(1);d.disableLayer(0);d.addTrackballControl(this._render,this._domContainer);this._quadViews.push(b);this._quadViews.push(c);this._quadViews.push(e);this._quadViews.push(d);this._quadViewInteraction=new r(this._quadViews);this._quadViewInteraction.setMultiplaneContainer(this._multiplaneContainer);this._quadViewInteraction.onClickPlane("perspective",function(b){a.moveMultiplaneTo(b)})};g.prototype._initPlaneManager=function(){this._planeManager=new q(this._colormapManager,
this._multiplaneContainer);this._planeManager.enableLayerHiRez(0);this._planeManager.disableLayerHiRez(1);this._planeManager.enableLayerLoRez(1);this._planeManager.disableLayerLoRez(0)};g.prototype.initStat=function(){this._stats=new Stats;this._domContainer.appendChild(this._stats.dom)};g.prototype._updateSize=function(){if(this._windowSize.width!=window.innerWidth||this._windowSize.height!=window.innerHeight)this._windowSize.width=window.innerWidth,this._windowSize.height=window.innerHeight,this._quadViewInteraction.updateWindowSize(this._windowSize.width,
this._windowSize.height),this._renderer.setSize(this._windowSize.width,this._windowSize.height)};g.prototype._animate=function(){this._render();this._stats&&this._stats.update();requestAnimationFrame(this._animate.bind(this));this._quadViews[3].updateControl()};g.prototype._render=function(){this._ready&&(0==this._counterRefresh%30&&this._updateAllPlanesShaderUniforms(),this._counterRefresh++);this._quadViews.forEach(function(a){a.renderView()})};g.prototype._initUI=function(){var a=this;this._guiVar=
{posx:0,posy:0,posz:0,rotx:0,roty:0,rotz:0,frustrum:1,resolutionLevel:a._resolutionLevel,colormapChoice:0,toggleOrientationHelper:function(){a._orientationHelper.toggle()},toggleCubeHull:function(){a.toggleCubeHull()},refresh:function(){a._updateAllPlanesShaderUniforms()},debug:function(){a._adjustedContainer.visible=!a._adjustedContainer.visible},meshx:.98,meshy:.8,meshz:1.04,meshscalex:85,meshscaley:85,meshscalez:85};this._datGui.add(this._guiVar,"meshx",0,1.5).step(.001).onChange(function(b){a._meshContainer.position.x=
b});this._datGui.add(this._guiVar,"meshy",0,1.5).step(.001).onChange(function(b){a._meshContainer.position.y=b});this._datGui.add(this._guiVar,"meshz",0,1.5).step(.001).onChange(function(b){a._meshContainer.position.z=b});this._datGui.add(this._guiVar,"meshscalex",80,110).step(.001).onChange(function(b){a._meshContainer.scale.x=1/b});this._datGui.add(this._guiVar,"meshscaley",80,110).step(.001).onChange(function(b){a._meshContainer.scale.y=1/b});this._datGui.add(this._guiVar,"meshscalez",80,110).step(.001).onChange(function(b){a._meshContainer.scale.z=
1/b});this._datGui.add(this._guiVar,"toggleOrientationHelper").name("Toggle helper");this._datGui.add(this._guiVar,"toggleCubeHull").name("Toggle cube");var b=this._datGui.add(this._guiVar,"resolutionLevel",0,6).name("resolutionLevel").step(1).listen();this._datGui.add(this._guiVar,"debug");b.onFinishChange(function(b){a.setResolutionLevel(b)});this._colormapManager.onColormapUpdate(this._updateColormapList.bind(this))};g.prototype._updateColormapList=function(){var a=this;"undefined"!==typeof this._colormapController&&
(this._datGui.remove(this._colormapController),this._colormapController=null);this._colormapController=this._datGui.add(this._guiVar,"colormapChoice",this._colormapManager.getAvailableColormaps()).name("color map");this._colormapController.onFinishChange(function(b){a._colormapManager.useColormap(b)})};g.prototype.setMainObjectPosition=function(a,b,c){0<a&&a<this._cubeHullSize[0]&&0<b&&b<this._cubeHullSize[1]&&0<c&&c<this._cubeHullSize[2]&&(this._multiplaneContainer.position.x=a,this._multiplaneContainer.position.y=
b,this._multiplaneContainer.position.z=c,this._guiVar.posx=a,this._guiVar.posy=b,this._guiVar.posz=c,this._updateAllPlanesShaderUniforms(),this._updatePerspectiveCameraLookAt(),this._syncOrientationHelperPosition())};g.prototype.setMainObjectPositionX=function(a){0<a&&a<this._cubeHullSize[0]&&(this._multiplaneContainer.position.x=a,this._updateAllPlanesShaderUniforms(),this._updatePerspectiveCameraLookAt(),this._guiVar.posx=a,this._syncOrientationHelperPosition())};g.prototype.setMainObjectPositionY=
function(a){0<a&&a<this._cubeHullSize[1]&&(this._multiplaneContainer.position.y=a,this._updateAllPlanesShaderUniforms(),this._updatePerspectiveCameraLookAt(),this._guiVar.posy=a,this._syncOrientationHelperPosition())};g.prototype.setMainObjectPositionZ=function(a){0<a&&a<this._cubeHullSize[2]&&(this._multiplaneContainer.position.z=a,this._updateAllPlanesShaderUniforms(),this._updatePerspectiveCameraLookAt(),this._guiVar.posz=a,this._syncOrientationHelperPosition())};g.prototype.setMainObjectRotation=
function(a,b,c){this._multiplaneContainer.rotation.x=a;this._multiplaneContainer.rotation.y=b;this._multiplaneContainer.rotation.z=c;this._guiVar.rotx=a;this._guiVar.roty=b;this._guiVar.rotz=c;this._updateAllPlanesShaderUniforms()};g.prototype.loadData=function(a){"precomputed_octree_tiles"==a.datatype?this._initLevelManager(a):"mesh_collection"==a.datatype?this._initMeshCollection(a):console.warn("The data to load has an unknown format.")};g.prototype._initMeshCollection=function(a){this._meshCollection=
new y(a,this._meshContainer)};g.prototype._initLevelManager=function(a){var b=this;this._levelManager.loadConfig(a);this._levelManager.onReady(function(){b._planeManager.setLevelManager(b._levelManager);b._levelManager.setResolutionLevel(b._resolutionLevel);b._buildCubeHull();b.setMainObjectPosition(b._cubeHullSize[0]/2,b._cubeHullSize[1]/2,b._cubeHullSize[2]/2);b._initOrientationHelper();b.setResolutionLevel(b._resolutionLevel);b._initPlaneInteraction();b._ready=!0;b._onReadyCallback&&b._onReadyCallback(b)});
this._levelManager.onConfigError(function(a,d){b._onConfigFileErrorCallback&&b._onConfigFileErrorCallback(a,d)})};g.prototype.setResolutionLevel=function(a){console.log("--------- LVL "+a+" ---------------");this._resolutionLevel=a;this._levelManager.setResolutionLevel(this._resolutionLevel);this._planeManager.updateScaleFromRezLvl(this._resolutionLevel);this._syncOrientationHelperScale();this._guiVar.resolutionLevel=a;this._updateOthoCamFrustrum();this._onUpdateViewCallback&&this._onUpdateViewCallback(this.getMainObjectInfo())};
g.prototype._updateAllPlanesShaderUniforms=function(){this._planeManager.updateUniforms()};g.prototype._updatePerspectiveCameraLookAt=function(){this._quadViews[3].updateLookAt(this._multiplaneContainer.position)};g.prototype._updateOthoCamFrustrum=function(){var a=1/Math.pow(2,this._resolutionLevel);this._quadViews[0].updateOrthoCamFrustrum(a);this._quadViews[1].updateOrthoCamFrustrum(a);this._quadViews[2].updateOrthoCamFrustrum(a)};g.prototype.showCubeHull=function(){this._cubeHull3D?this._cubeHull3D.visible=
!0:this._buildCubeHull()};g.prototype.hideCubeHull=function(){this._cubeHull3D&&(this._cubeHull3D.visible=!1)};g.prototype.toggleCubeHull=function(){this._cubeHull3D&&(this._cubeHull3D.visible=!this._cubeHull3D.visible)};g.prototype._buildCubeHull=function(){if(!this._cubeHull3D){this._cubeHullSize=this._levelManager.getCubeHull();var a=new THREE.MeshBasicMaterial({transparent:!0,opacity:.8,color:16777215,vertexColors:THREE.FaceColors,side:THREE.BackSide}),b=new THREE.BoxGeometry(this._cubeHullSize[0],
this._cubeHullSize[1],this._cubeHullSize[2]);b.faces[0].color.setHex(16743034);b.faces[1].color.setHex(16743034);b.faces[2].color.setHex(16724787);b.faces[3].color.setHex(16724787);b.faces[4].color.setHex(6421140);b.faces[5].color.setHex(6421140);b.faces[6].color.setHex(11008707);b.faces[7].color.setHex(11008707);b.faces[8].color.setHex(9817340);b.faces[9].color.setHex(9817340);b.faces[10].color.setHex(35071);b.faces[11].color.setHex(35071);a=new THREE.Mesh(b,a);this._cubeHull3D=new THREE.Object3D;
this._cubeHull3D.add(a);this._cubeHull3D.position.x=this._cubeHullSize[0]/2;this._cubeHull3D.position.y=this._cubeHullSize[1]/2;this._cubeHull3D.position.z=this._cubeHullSize[2]/2;this._cubeHull3D.children.forEach(function(a){a.layers.disable(0);a.layers.enable(1)});this._scene.add(this._cubeHull3D)}};g.prototype._initOrientationHelper=function(){this._orientationHelper=new x(this._planeManager.getWorldDiagonalHiRez()/13);this._orientationHelper.addTo(this._scene);this._syncOrientationHelperPosition()};
g.prototype._syncOrientationHelperPosition=function(){this._orientationHelper&&this._orientationHelper.setPosition(this._multiplaneContainer.position)};g.prototype._syncOrientationHelperScale=function(){this._orientationHelper.rescaleFromResolutionLvl(this._resolutionLevel)};g.prototype.rotateNativePlaneX=function(a){this._rotateNativePlane(2,a)};g.prototype.rotateNativePlaneY=function(a){this._rotateNativePlane(1,a)};g.prototype.rotateNativePlaneZ=function(a){this._rotateNativePlane(0,a)};g.prototype._rotateNativePlane=
function(a,b){a=this._planeManager.getWorldVectorN(a);this._multiplaneContainer.rotateOnAxis(a,b);this._updateAllPlanesShaderUniforms()};g.prototype.translateNativePlaneX=function(a,b){this._translateNativePlane(2,a,b)};g.prototype.translateNativePlaneY=function(a,b){this._translateNativePlane(1,a,b)};g.prototype.translateNativePlaneZ=function(a,b){this._translateNativePlane(0,a,b)};g.prototype._translateNativePlane=function(a,b,c){var d=this._planeManager.getWorldVectorU(a);a=this._planeManager.getWorldVectorV(a);
this._multiplaneContainer.translateOnAxis(d,b);this._multiplaneContainer.translateOnAxis(a,c);this._updateAllPlanesShaderUniforms();this._updatePerspectiveCameraLookAt();this._syncOrientationHelperPosition()};g.prototype.moveMultiplaneTo=function(a){this._multiplaneContainer.position.set(a.x,a.y,a.z);this._updateAllPlanesShaderUniforms();this._updatePerspectiveCameraLookAt();this._syncOrientationHelperPosition()};g.prototype.onReady=function(a){this._onReadyCallback=a};g.prototype._initPlaneInteraction=
function(){var a=this;this._quadViewInteraction.onGrabViewTranslate(function(b,c){var d=Math.pow(2,a._resolutionLevel);switch(c){case 0:a.translateNativePlaneX(-b.x/d,b.y/d);break;case 1:a.translateNativePlaneY(b.x/d,b.y/d);break;case 2:a.translateNativePlaneZ(b.x/d,-b.y/d)}});this._quadViewInteraction.onGrabViewRotate(function(b,c,d){switch(d){case 0:a.rotateNativePlaneX(b*c);break;case 1:a.rotateNativePlaneY(b*c*-1);break;case 2:a.rotateNativePlaneZ(b*c)}});this._quadViewInteraction.onGrabViewTransverseRotate(function(b,
c){var d=a._resolutionLevel/2;switch(c){case 0:a.rotateNativePlaneZ(b.x/d);a.rotateNativePlaneY(-b.y/d);break;case 1:a.rotateNativePlaneX(-b.y/d);a.rotateNativePlaneZ(b.x/d);break;case 2:a.rotateNativePlaneX(-b.y/d),a.rotateNativePlaneY(b.x/d)}});this._quadViewInteraction.onArrowDown(function(b){var c=.01/Math.pow(2,a._resolutionLevel);switch(b){case 0:a.translateNativePlaneY(c,0);break;case 1:a.translateNativePlaneX(c,0);break;case 2:a.translateNativePlaneY(0,-c)}});this._quadViewInteraction.onArrowUp(function(b){var c=
.01/Math.pow(2,a._resolutionLevel)*-1;switch(b){case 0:a.translateNativePlaneY(c,0);break;case 1:a.translateNativePlaneX(c,0);break;case 2:a.translateNativePlaneY(0,-c)}});this._quadViewInteraction.onDonePlaying(function(){a._onUpdateViewCallback&&a._onUpdateViewCallback(a.getMainObjectInfo())})};g.prototype.getMainObjectInfo=function(){return{resolutionLvl:this._resolutionLevel,position:{x:this._multiplaneContainer.position.x,y:this._multiplaneContainer.position.y,z:this._multiplaneContainer.position.z},
rotation:{x:this._multiplaneContainer.rotation.x,y:this._multiplaneContainer.rotation.y,z:this._multiplaneContainer.rotation.z}}};g.prototype.onUpdateView=function(a){this._onUpdateViewCallback=a};g.prototype.onConfigFileError=function(a){this._onConfigFileErrorCallback=a};d.TextureChunk=f;d.ChunkCollection=l;d.LevelManager=t;d.HashIO=h;d.QuadScene=g;Object.defineProperty(d,"__esModule",{value:!0})});
